sequenceDiagram
    autonumber
    actor Source as Excel (Input Rows)
    participant Clean as Normalize & Preprocess
    participant Pin as Pincode Validator
    participant City as City Resolver
    participant State as State Resolver
    participant Guard as Edge-Case Checks
    participant Conf as Confidence Scorer
    participant Out as Standardized Output
    participant MR as Manual Review

    Source->>Clean: Load & clean Address1..3
    Clean->>Pin: Extract 6-digit PIN
    alt Valid PIN in Master DB
        Pin->>City: Derive City & State from PIN
        alt Matches input address
            City->>Conf: Mark High Confidence
            Conf->>Out: Save standardized record
        else Mismatch with input
            City->>Guard: Flag CITY_MISMATCH
            Guard->>MR: Send for manual review
        end
    else Invalid / Missing PIN
        Pin->>City: Try resolving by City string
        alt Unique City found in DB
            City->>State: Derive State
            State->>Conf: Mark Medium Confidence
            Conf->>Out: Save standardized record
        else Ambiguous (same City in multiple States)
            City->>State: Check if State provided in input
            alt Matches one of possible States
                State->>Conf: Accept with Medium Confidence
                Conf->>Out: Save standardized record
            else No valid State match
                State->>Guard: Flag AMBIGUOUS_CITY_STATE
                Guard->>MR: Manual review
            end
        end
    end

    %% Edge case handling
    Guard->>MR: Handle fake PINs (000000, 123456, 600000) or invalid formats
