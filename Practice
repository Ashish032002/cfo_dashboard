sequenceDiagram
    autonumber
    actor Ops as Batch Orchestrator
    participant XLS as Excel Source (Address1..3, City, Pincode, State, Country)
    participant Pre as Ingest & Normalize
    participant H as Hierarchy-of-Trust Rules
    participant Ctry as Country Validator
    participant Pin as Pincode Extractor/Validator
    participant CS as City/State Resolver
    participant Edge as Edge-Case Guard
    participant Conf as Confidence Scorer
    participant Route as Decision Router
    participant Out as Target Table (City, State, Country, Pincode)
    participant MR as Manual Review Queue
    participant Log as Audit & Lineage
    participant Met as Metrics

    %% 0. Orchestration
    Ops->>XLS: Read next batch (N rows)
    XLS-->>Ops: Raw rows
    loop For each row
      %% 1. Aggregate & clean
      Ops->>Pre: Concatenate Address1..3 → full_address_string
      Pre->>Pre: normalize (lowercase, trim, unify separators)
      Pre->>Pre: remove noise (c/o, landmark, phone, emails)
      Pre-->>H: cleaned_address + original columns

      %% 2. Country check (must be India in PoC)
      H->>Ctry: fuzzy match Country against master list
      alt Country is "India" OR empty-but-Indian evidence
        Ctry-->>H: OK (country=India)
      else Foreign token present (e.g., "Singapore","SGP","UAE")
        Ctry-->>H: FOREIGN_COUNTRY_IN_ADDRESS
        H->>Log: write evidence + code
        H->>MR: enqueue row (block auto-parse)
      end

      %% 3. Pincode-first resolution
      H->>Pin: extract 6-digit pattern from pincode col then string
      alt Valid pincode (in master) and not blacklisted (e.g., 600000, 123456)
        Pin-->>H: canonical PIN + City/District/State
        H->>CS: cross-check provided City/State vs PIN-derived
        alt Matches
          CS-->>H: CONSISTENT
        else Mismatch
          CS-->>H: CITY_MISMATCH (trust PIN per hierarchy)
          H->>Log: record mismatch + override rationale
        end
      else No pincode / invalid format / not in master
        Pin-->>H: INVALID_OR_MISSING_PIN
        H->>CS: parse City & State from string via master dictionaries
        alt Unique resolution (1 city-state hit)
          CS-->>H: canonical City/State
        else Ambiguous (e.g., duplicate city names across states)
          CS-->>H: AMBIGUOUS_CITY_STATE
          H->>Log: record ambiguity evidence
          H->>MR: enqueue row (needs human choice)
        end
      end

      %% 4. Edge-case guards before commit
      H->>Edge: run guards (Singapore localities, fake PINs, position heuristics)
      alt Any guard triggered (e.g., PIN inside building code, "600000")
        Edge-->>H: GUARD_HIT + code
        H->>Log: write guard details
        H->>MR: enqueue row
      else
        Edge-->>H: PASS
      end

      %% 5. Confidence & routing
      H->>Conf: score(factors: PIN validity, cross-checks, conflicts, heuristics)
      Conf-->>H: score ∈ [0,1], rationale, labels {HIGH/MED/LOW}
      alt score ≥ 0.90 (HIGH)
        H->>Out: upsert {Country=India, State, City, Pincode}
        H->>Log: full lineage (inputs, matches, rules, score)
      else score in [0.70,0.90) (MED)
        H->>Out: upsert + REVIEW_FLAG (soft hold)
        H->>MR: enqueue if policy requires
        H->>Log: lineage + reason
      else score < 0.70 (LOW)
        H->>MR: enqueue with evidence & suggested options
        H->>Log: lineage + reason
      end

      %% 6. Metrics
      Ops->>Met: emit counters (auto-parse rate, mismatch counts, guard hits)
    end
